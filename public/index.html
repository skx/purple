
<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Alerts [0/0/0]</title>
    <meta http-equiv="refresh" content="55">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <script src="/js/jquery-2.2.4.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <style type="text/css">
      .wrapper {
        margin-bottom: 100px;
      }
      .steve-footer {
      margin-top: 70px;
      color: #999;
      background-color: #f9f9f9;
      border-top: 1px solid #e5e5e5;
      }
      .steve-footer .nav-header {
      color: black;
      font-weight: bold;
      }
      .click {
        cursor: pointer;
      }
    </style>

    <script type="text/javascript">
      window.onload = function(){
      if (location.hash !== '') $('a[href="' + location.hash + '"]').tab('show');
      $('a[data-toggle="tab"]').bind('click', function(e) {
      location.hash = $(e.target).attr('href').substr(1);
      }
      );

      // clicking on the subject will toggle the details.
      $( "table" ).delegate( "tr .click",  "click", function(  ) {
          $(this).closest('tr').next('tr').toggle(); } );
      }

    </script>
    <script type="text/javascript">
      (function() {

      $.getJSON( "/events" , function( data ) {
      var h = {};
      h['raised'] = 0
      h['pending'] = 0
      h['acknowledged'] = 0

      $.each( data, function( key, val ) {

      // Bump the count of this type of alerts, so we can update the title.
      var status = val['status'];
      h[status] = h[status]+1

      // This is horrid - we want to show either "will raise at",
      // "last notified at", or nothing depending on the type.
      if ( status == "raised" ) {

      var d = Math.round( val['notified_at'] * 1000)
      d = parseFloat(d);
      d = new Date( d  );

      // id | source | subject | last notified | action
      var t = "<tr><td>" + val['i'] + "</td>";
        t += "<td>" + val['source'] + "</td>";
        t += "<td class=\"click\">" + val['subject'] + "</td>";
        t += "<td>" + d  + "</td>";
        t += "<td><a href=\"/acknowledge/" + (val['i']) + "\">ack</a>"
        t += " <a href=\"/clear/" + (val['i']) + "\">clear</a>"
        t += "</td>"

        // Add the alert
        $("#" + val['status'] + "_alerts").find('tbody').append(t)

        // Add the details.
        $("#" + val['status'] + "_alerts").find('tbody')
        .append("<tr style=\"display:none;\"><td></td><td colspan=\"4\"><p>" + val['detail'] + "</p></td></tr>")
      }
      if ( status == "acknowledged" ) {

      // id | source | subject | last notified | action
      var t = "<tr><td>" + val['i'] + "</td>";
        t += "<td>" + val['source'] + "</td>";
        t += "<td class=\"click\">" + val['subject'] + "</td>";
        t += "<td><a href=\"/raise/" + (val['i']) + "\">raise</a> <a href=\"/clear/" + (val['i']) + "\">clear</a></td>"

        // Add the alert
        $("#" + val['status'] + "_alerts").find('tbody').append(t)

        // Add the details.
        $("#" + val['status'] + "_alerts").find('tbody')
        .append("<tr style=\"display:none;\"><td></td><td colspan=\"4\"><p>" + val['detail'] + "</p></td></tr>")

      }
      if ( status == "pending" ) {

      var d = Math.round( val['raise_at'] * 1000)
      d = parseFloat(d);
      d = new Date( d  );

      // id | source | subject | last notified | action
      var t = "<tr><td>" + val['i'] + "</td>";
        t += "<td>" + val['source'] + "</td>";
        t += "<td class=\"click\">" + val['subject'] + "</td>";
        t += "<td>" + d  + "</td>";
        t += "<td><a href=\"/clear/" + (val['i']) + "\">clear</a></td>"

        // Add the alert
        $("#" + val['status'] + "_alerts").find('tbody').append(t)

        // Add the details.
        $("#" + val['status'] + "_alerts").find('tbody')
        .append("<tr style=\"display:none;\"><td></td><td colspan=\"4\"><p>" + val['detail'] + "</p></td></tr>")
      }


      // Set the title.
      document.title = "Alerts [" + h['raised'] + "/" + h['acknowledged'] + "/" + h['pending'] + "]";

      });
      });
      })();
    </script>
  </head>
  <body>
    <nav class="navbar navbar-default">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Purple Alert Index</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="/">Home</a></li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li ><a href="/logout">Logout</a></li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="wrapper">
      <div class="container">
        <h2>Alerts</h2>
        <ul class="nav nav-tabs" id="myTab">
          <li class="active"><a data-toggle="tab" href="#raised">Raised</a></li>
          <li><a data-toggle="tab" href="#acknowledged">Acknowledged</a></li>
          <li><a data-toggle="tab" href="#pending">Pending</a></li>
        </ul>

        <div class="tab-content">
          <div id="raised" class="tab-pane fade in active">
            <p>&nbsp;</p>
            <table id="raised_alerts" class="table table-striped table-hover table-bordered table-condensed" >
              <tr><th>#</th><th>Source</th><th>Subject</th><th>Last Notified At</th><th>Actions</th></tr>
            </table>
          </div>
          <div id="acknowledged" class="tab-pane fade">
            <p>&nbsp;</p>
            <table id="acknowledged_alerts" class="table table-striped table-hover table-bordered table-condensed" >
              <tr><th>#</th><th>Source</th><th>Subject</th><th>Actions</th></tr>
            </table>
          </div>
          <div id="pending" class="tab-pane fade">
            <p>&nbsp;</p>
            <table id="pending_alerts" class="table table-striped table-hover table-bordered table-condensed" >
              <tr><th>#</th><th>Source</th><th>Subject</th><th>Raise Time</th><th>Actions</th></tr>
            </table>
          </div>
        </div>
      </div>
    </div>
    <footer id="footer" class="footer navbar-fixed-bottom steve-footer" role="navigation">
      <div class="container">
        <div class="col-md-6">
          <ul class="nav">
            <li class="nav-header">Source Code</li>
            <li><a href="https://github.com/skx/purple">Available on github</a></li>
          </ul>
        </div>
        <div class="col-md-6">
          <ul class="nav ">
            <li class="nav-header">Copyright</li>
            <li>@ Steve Kemp</li>
          </ul>
        </div>
      </div>
    </footer>
  </body>
</html>
